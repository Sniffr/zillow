{% extends "base.html" %}

{% block title %}Message Templates - Zillow Property Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-envelope"></i> Message Templates</h1>
            <button class="btn btn-primary" onclick="showAddMessageTemplateModal()">
                <i class="fas fa-plus"></i> Add New Template
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="messageTemplatesTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Default</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Message Template Modal -->
<div class="modal fade" id="messageTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageTemplateModalTitle">Add Message Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="messageTemplateForm">
                    <input type="hidden" id="messageTemplateId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="templateName" class="form-label">Template Name *</label>
                                <input type="text" class="form-control" id="templateName" name="name" required>
                                <div class="form-text">e.g., "Initial Contact", "Follow-up"</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="templateCategory" class="form-label">Category</label>
                                <select class="form-control" id="templateCategory" name="category">
                                    <option value="general">General</option>
                                    <option value="initial">Initial Contact</option>
                                    <option value="follow_up">Follow-up</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateText" class="form-label">Template Text *</label>
                        <textarea class="form-control" id="templateText" name="template_text" rows="8" required></textarea>
                        <div class="form-text">
                            <strong>Available variables:</strong> {agent_name}, {property_address}, {property_price}, {search_area}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isDefault" name="is_default">
                            <label class="form-check-label" for="isDefault">
                                Set as default template
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMessageTemplate()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- View Message Template Modal -->
<div class="modal fade" id="viewMessageTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Message Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templateViewContent">
                    <!-- Template content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteMessageTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this message template?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteMessageTemplate()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let messageTemplatesTable;
let currentMessageTemplateId = null;

$(document).ready(function() {
    initializeMessageTemplatesTable();
});

function initializeMessageTemplatesTable() {
    messageTemplatesTable = $('#messageTemplatesTable').DataTable({
        ajax: {
            url: '/api/message_templates',
            dataSrc: 'data'
        },
        columns: [
            { data: 'id' },
            { data: 'name' },
            { data: 'category' },
            { data: 'description' },
            { 
                data: 'is_default',
                render: function(data) {
                    if (data === 'Yes') {
                        return '<span class="badge bg-primary">Default</span>';
                    }
                    return '<span class="badge bg-secondary">No</span>';
                }
            },
            { 
                data: 'is_active',
                render: function(data) {
                    const badgeClass = data === 'Active' ? 'success' : 'secondary';
                    return `<span class="badge bg-${badgeClass}">${data}</span>`;
                }
            },
            { data: 'created_at' },
            { 
                data: 'actions',
                orderable: false,
                searchable: false
            }
        ],
        order: [[0, 'desc']],
        responsive: true,
        pageLength: 25,
        createdRow: function(row, data, dataIndex) {
            $(row).attr('data-id', data.id);
        }
    });
}

function showAddMessageTemplateModal() {
    currentMessageTemplateId = null;
    $('#messageTemplateModalTitle').text('Add Message Template');
    $('#messageTemplateForm')[0].reset();
    $('#isDefault').prop('checked', false);
    $('#messageTemplateModal').modal('show');
}

function editMessageTemplate(id) {
    currentMessageTemplateId = id;
    
    // Get the current row data
    const row = messageTemplatesTable.row(`[data-id="${id}"]`).data();
    
    // Populate the form
    $('#messageTemplateId').val(id);
    $('#templateName').val(row.name);
    $('#templateCategory').val(row.category);
    $('#templateDescription').val(row.description);
    $('#templateText').val(row.template_text);
    $('#isDefault').prop('checked', row.is_default === 'Yes');
    
    $('#messageTemplateModalTitle').text('Edit Message Template');
    $('#messageTemplateModal').modal('show');
}

function viewMessageTemplate(id) {
    $.ajax({
        url: `/api/message_templates/${id}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const template = response.data;
                
                let variablesHtml = '';
                if (template.available_variables) {
                    try {
                        const variables = JSON.parse(template.available_variables);
                        if (variables.length > 0) {
                            variablesHtml = `<p><strong>Variables:</strong> ${variables.join(', ')}</p>`;
                        }
                    } catch (e) {
                        // Ignore parsing errors
                    }
                }
                
                const content = `
                    <h6>Template Details</h6>
                    <p><strong>Name:</strong> ${template.name}</p>
                    <p><strong>Category:</strong> ${template.category}</p>
                    <p><strong>Description:</strong> ${template.description || 'No description'}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${template.is_active ? 'success' : 'secondary'}">${template.is_active ? 'Active' : 'Inactive'}</span></p>
                    <p><strong>Default:</strong> <span class="badge bg-${template.is_default ? 'primary' : 'secondary'}">${template.is_default ? 'Yes' : 'No'}</span></p>
                    <p><strong>Created:</strong> ${template.created_at}</p>
                    ${variablesHtml}
                    <hr>
                    <h6>Template Text</h6>
                    <div class="border p-3 bg-light">
                        <pre style="white-space: pre-wrap; font-family: inherit;">${template.template_text}</pre>
                    </div>
                `;
                
                $('#templateViewContent').html(content);
                $('#viewMessageTemplateModal').modal('show');
            } else {
                showToast('Error', response.message, 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to load template', 'error');
        }
    });
}

function saveMessageTemplate() {
    const formData = {
        name: $('#templateName').val(),
        template_text: $('#templateText').val(),
        description: $('#templateDescription').val(),
        category: $('#templateCategory').val(),
        is_default: $('#isDefault').is(':checked'),
        available_variables: JSON.stringify(['agent_name', 'property_address', 'property_price', 'search_area'])
    };
    
    if (currentMessageTemplateId) {
        // Update existing
        $.ajax({
            url: `/api/message_templates/${currentMessageTemplateId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showToast('Success', response.message, 'success');
                    $('#messageTemplateModal').modal('hide');
                    messageTemplatesTable.ajax.reload();
                } else {
                    showToast('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('Error', response ? response.message : 'Failed to update message template', 'error');
            }
        });
    } else {
        // Create new
        $.ajax({
            url: '/api/message_templates',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showToast('Success', response.message, 'success');
                    $('#messageTemplateModal').modal('hide');
                    messageTemplatesTable.ajax.reload();
                } else {
                    showToast('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('Error', response ? response.message : 'Failed to create message template', 'error');
            }
        });
    }
}

function toggleMessageTemplate(id, isActive) {
    $.ajax({
        url: `/api/message_templates/${id}/toggle`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showToast('Success', response.message, 'success');
                messageTemplatesTable.ajax.reload();
            } else {
                showToast('Error', response.message, 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to toggle message template', 'error');
        }
    });
}

function setDefaultMessageTemplate(id) {
    $.ajax({
        url: `/api/message_templates/${id}/set_default`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showToast('Success', response.message, 'success');
                messageTemplatesTable.ajax.reload();
            } else {
                showToast('Error', response.message, 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to set default template', 'error');
        }
    });
}

function deleteMessageTemplate(id) {
    currentMessageTemplateId = id;
    $('#deleteMessageTemplateModal').modal('show');
}

function confirmDeleteMessageTemplate() {
    if (!currentMessageTemplateId) return;
    
    $.ajax({
        url: `/api/message_templates/${currentMessageTemplateId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                showToast('Success', response.message, 'success');
                $('#deleteMessageTemplateModal').modal('hide');
                messageTemplatesTable.ajax.reload();
            } else {
                showToast('Error', response.message, 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to delete message template', 'error');
        }
    });
}

function showToast(title, message, type) {
    const toastHtml = `
        <div class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    $('.toast-container').append(toastHtml);
    $('.toast').last().toast('show');
}
</script>
{% endblock %}
