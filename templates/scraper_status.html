{% extends "base.html" %}

{% block title %}Scraper Status - Zillow Property Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-chart-line"></i> Scraper Status</h1>
            <div>
                <button class="btn btn-success me-2" onclick="runScraper()">
                    <i class="fas fa-play"></i> Run Scraper
                </button>
                <button class="btn btn-primary me-2" id="schedulerStartBtn" onclick="startScheduler()">
                    <i class="fas fa-clock"></i> Start Scheduler
                </button>
                <button class="btn btn-warning me-2" id="schedulerStopBtn" onclick="stopScheduler()">
                    <i class="fas fa-stop"></i> Stop Scheduler
                </button>
                <button class="btn btn-info" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt"></i> Refresh Logs
                </button>
            </div>
        </div>

        <!-- Scraper Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Status</h5>
                        <h3 id="scraperStatus">Unknown</h3>
                        <p class="card-text">Current scraper status</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Last Run</h5>
                        <h3 id="lastRun">Never</h3>
                        <p class="card-text">Last successful execution</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Next Run</h5>
                        <h3 id="nextRun">Not Scheduled</h3>
                        <p class="card-text">Next scheduled execution</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Properties</h5>
                        <h3 id="totalProperties">0</h3>
                        <p class="card-text">Total in database</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduler Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Runs</h5>
                        <h3 id="totalRuns">0</h3>
                        <p class="card-text">Total executions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Successful</h5>
                        <h3 id="successfulRuns">0</h3>
                        <p class="card-text">Successful executions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Failed</h5>
                        <h3 id="failedRuns">0</h3>
                        <p class="card-text">Failed executions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-white">
                    <div class="card-body">
                        <h5 class="card-title">Log Files</h5>
                        <h3 id="logFileCount">0</h3>
                        <p class="card-text">Total log files</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Files Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt"></i> Log Files
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="logFilesTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Size</th>
                                <th>Last Modified</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Log files will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Live Log Viewer -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-terminal"></i> Live Log Viewer
                    <span id="currentLogFile" class="badge bg-secondary ms-2">No file selected</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select id="logFileSelector" class="form-select" onchange="loadLogContent()">
                        <option value="">Select a log file to view...</option>
                    </select>
                </div>
                <div id="logContent" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                    <div class="text-muted">Select a log file to view its contents...</div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLogViewer()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="downloadCurrentLog()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Run Scraper Confirmation Modal -->
<div class="modal fade" id="runScraperModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Scraper Execution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to run the Zillow scraper?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will start the scraping process which may take several minutes and will use API resources.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmRunScraper()">
                    <i class="fas fa-play"></i> Run Scraper
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let logFilesTable;
let currentLogFile = null;

$(document).ready(function() {
    initializeLogFilesTable();
    loadScraperStatus();
    refreshLogs();
    updateSchedulerButtons();
});

function initializeLogFilesTable() {
    logFilesTable = $('#logFilesTable').DataTable({
        ajax: {
            url: '/api/log_files',
            dataSrc: 'data'
        },
        columns: [
            { data: 'filename' },
            { data: 'size' },
            { data: 'last_modified' },
            { 
                data: 'status',
                render: function(data) {
                    const badgeClass = data === 'Success' ? 'success' : 
                                     data === 'Error' ? 'danger' : 
                                     data === 'Running' ? 'warning' : 'secondary';
                    return `<span class="badge bg-${badgeClass}">${data}</span>`;
                }
            },
            { 
                data: 'actions',
                orderable: false,
                searchable: false
            }
        ],
        order: [[2, 'desc']], // Sort by last modified date
        responsive: true,
        pageLength: 10
    });
}

function loadScraperStatus() {
    $.ajax({
        url: '/api/scraper_status',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#scraperStatus').text(response.data.status);
                $('#lastRun').text(response.data.last_run || 'Never');
                $('#nextRun').text(response.data.scheduler_status?.next_run || 'Not Scheduled');
                $('#totalProperties').text(response.data.total_properties || 0);
                $('#totalRuns').text(response.data.scheduler_status?.total_runs || 0);
                $('#successfulRuns').text(response.data.scheduler_status?.successful_runs || 0);
                $('#failedRuns').text(response.data.scheduler_status?.failed_runs || 0);
                $('#logFileCount').text(response.data.log_file_count || 0);
                
                // Update scheduler button states
                updateSchedulerButtons();
            }
        },
        error: function(xhr) {
            console.error('Failed to load scraper status:', xhr);
        }
    });
}

function refreshLogs() {
    if (logFilesTable) {
        logFilesTable.ajax.reload();
    }
    loadScraperStatus();
    
    // Refresh log file selector
    $.ajax({
        url: '/api/log_files',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const selector = $('#logFileSelector');
                selector.empty();
                selector.append('<option value="">Select a log file to view...</option>');
                
                response.data.forEach(logFile => {
                    selector.append(`<option value="${logFile.filename}">${logFile.filename}</option>`);
                });
            }
        }
    });
}

function runScraper() {
    $('#runScraperModal').modal('show');
}

function confirmRunScraper() {
    $('#runScraperModal').modal('hide');
    
    // Show loading state
    const btn = $('button[onclick="runScraper()"]');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin"></i> Running...');
    btn.prop('disabled', true);
    
    $.ajax({
        url: '/api/run_scraper',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showToast('Success', 'Scraper started successfully', 'success');
                // Start polling for status updates
                pollScraperStatus();
            } else {
                showToast('Error', response.message || 'Failed to start scraper', 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to start scraper', 'error');
        },
        complete: function() {
            // Restore button state
            btn.html(originalText);
            btn.prop('disabled', false);
        }
    });
}

function pollScraperStatus() {
    const pollInterval = setInterval(function() {
        $.ajax({
            url: '/api/scraper_status',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    loadScraperStatus();
                    
                    // Stop polling if scraper is no longer running
                    if (response.data.status !== 'Running') {
                        clearInterval(pollInterval);
                        refreshLogs();
                        showToast('Info', 'Scraper execution completed', 'info');
                    }
                }
            }
        });
    }, 5000); // Poll every 5 seconds
}

function startScheduler() {
    $.ajax({
        url: '/api/scheduler/start',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showToast('Success', response.message, 'success');
                updateSchedulerButtons();
            } else {
                showToast('Error', response.message, 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to start scheduler', 'error');
        }
    });
}

function stopScheduler() {
    $.ajax({
        url: '/api/scheduler/stop',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showToast('Success', response.message, 'success');
                updateSchedulerButtons();
            } else {
                showToast('Error', response.message, 'error');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showToast('Error', response ? response.message : 'Failed to stop scheduler', 'error');
        }
    });
}

function updateSchedulerButtons() {
    $.ajax({
        url: '/api/scheduler/status',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const isRunning = response.data.running;
                if (isRunning) {
                    $('#schedulerStartBtn').prop('disabled', true).addClass('btn-secondary').removeClass('btn-primary');
                    $('#schedulerStopBtn').prop('disabled', false).addClass('btn-warning').removeClass('btn-secondary');
                } else {
                    $('#schedulerStartBtn').prop('disabled', false).addClass('btn-primary').removeClass('btn-secondary');
                    $('#schedulerStopBtn').prop('disabled', true).addClass('btn-secondary').removeClass('btn-warning');
                }
            }
        }
    });
}

function loadLogContent() {
    const filename = $('#logFileSelector').val();
    if (!filename) {
        $('#logContent').html('<div class="text-muted">Select a log file to view its contents...</div>');
        $('#currentLogFile').text('No file selected').removeClass('bg-primary').addClass('bg-secondary');
        return;
    }
    
    currentLogFile = filename;
    $('#currentLogFile').text(filename).removeClass('bg-secondary').addClass('bg-primary');
    
    $.ajax({
        url: `/api/log_files/${encodeURIComponent(filename)}/content`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const content = response.data.content;
                const formattedContent = content.split('\n').map(line => {
                    // Highlight different log levels with colors
                    if (line.includes(' - ERROR - ')) {
                        return `<span class="text-danger">${escapeHtml(line)}</span>`;
                    } else if (line.includes(' - WARNING - ')) {
                        return `<span class="text-warning">${escapeHtml(line)}</span>`;
                    } else if (line.includes(' - INFO - ')) {
                        return `<span class="text-info">${escapeHtml(line)}</span>`;
                    } else {
                        return escapeHtml(line);
                    }
                }).join('<br>');
                
                $('#logContent').html(formattedContent);
                // Scroll to bottom
                $('#logContent').scrollTop($('#logContent')[0].scrollHeight);
            } else {
                $('#logContent').html(`<div class="text-danger">Error loading log content: ${response.message}</div>`);
            }
        },
        error: function(xhr) {
            $('#logContent').html('<div class="text-danger">Failed to load log content</div>');
        }
    });
}

function clearLogViewer() {
    $('#logContent').html('<div class="text-muted">Select a log file to view its contents...</div>');
    $('#logFileSelector').val('');
    $('#currentLogFile').text('No file selected').removeClass('bg-primary').addClass('bg-secondary');
    currentLogFile = null;
}

function downloadCurrentLog() {
    if (!currentLogFile) {
        showToast('Warning', 'Please select a log file first', 'warning');
        return;
    }
    
    const link = document.createElement('a');
    link.href = `/api/log_files/${encodeURIComponent(currentLogFile)}/download`;
    link.download = currentLogFile;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function viewLogFile(filename) {
    $('#logFileSelector').val(filename);
    loadLogContent();
}

function deleteLogFile(filename) {
    if (confirm(`Are you sure you want to delete the log file "${filename}"?`)) {
        $.ajax({
            url: `/api/log_files/${encodeURIComponent(filename)}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showToast('Success', 'Log file deleted successfully', 'success');
                    refreshLogs();
                    if (currentLogFile === filename) {
                        clearLogViewer();
                    }
                } else {
                    showToast('Error', response.message || 'Failed to delete log file', 'error');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('Error', response ? response.message : 'Failed to delete log file', 'error');
            }
        });
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(title, message, type) {
    const toastHtml = `
        <div class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    $('.toast-container').append(toastHtml);
    $('.toast').last().toast('show');
}
</script>
{% endblock %}
