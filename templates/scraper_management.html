{% extends "base.html" %}

{% block title %}Scraper Management - Zillow Property Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-robot text-primary"></i> Scraper Management
                </h1>
                <div>
                    <button class="btn btn-success me-2" onclick="startScraper()">
                        <i class="fas fa-play"></i> Start Scraper
                    </button>
                    <button class="btn btn-warning me-2" onclick="toggleScheduler()" id="schedulerToggle">
                        <i class="fas fa-clock"></i> Start Scheduler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Scheduler Status
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="schedulerStatus">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Scraper Status
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="scraperStatus">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-robot fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Next Run
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="nextRun">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Last Run
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lastRun">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-history fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration and Logs Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <ul class="nav nav-tabs card-header-tabs" id="scraperTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
                                <i class="fas fa-cog"></i> Configuration
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                                <i class="fas fa-list-alt"></i> Execution Logs
                            </button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content" id="scraperTabsContent">
                        <!-- Configuration Tab -->
                        <div class="tab-pane fade show active" id="config" role="tabpanel">
                            <form id="scraperConfigForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="isEnabled" class="form-label">Enable Scheduler</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="isEnabled">
                                                <label class="form-check-label" for="isEnabled">
                                                    Automatically run scraper on schedule
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="scheduleInterval" class="form-label">Schedule Interval (minutes)</label>
                                            <input type="number" class="form-control" id="scheduleInterval" min="1" max="1440" value="10">
                                            <div class="form-text">How often to run the scraper (1-1440 minutes)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="timeoutMinutes" class="form-label">Timeout (minutes)</label>
                                            <input type="number" class="form-control" id="timeoutMinutes" min="1" max="120" value="5">
                                            <div class="form-text">Maximum time to wait for scraper to complete</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="maxWorkers" class="form-label">Max Concurrent Workers</label>
                                            <input type="number" class="form-control" id="maxWorkers" min="1" max="20" value="5">
                                            <div class="form-text">Maximum number of concurrent search processes</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="retryAttempts" class="form-label">Retry Attempts</label>
                                            <input type="number" class="form-control" id="retryAttempts" min="1" max="10" value="3">
                                            <div class="form-text">Number of retry attempts for failed operations</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                    <button type="button" class="btn btn-secondary ms-2" onclick="testConfigUpdate()">
                                        <i class="fas fa-test"></i> Test Update
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Logs Tab -->
                        <div class="tab-pane fade" id="logs" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped" id="scraperLogsTable">
                                    <thead>
                                        <tr>
                                            <th>Execution ID</th>
                                            <th>Status</th>
                                            <th>Start Time</th>
                                            <th>Duration</th>
                                            <th>Searches</th>
                                            <th>Properties</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Viewer Modal -->
<div class="modal fade" id="logViewerModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scraper Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Execution ID:</strong> <span id="logExecutionId"></span><br>
                        <strong>Status:</strong> <span id="logStatus"></span><br>
                        <strong>Start Time:</strong> <span id="logStartTime"></span><br>
                        <strong>End Time:</strong> <span id="logEndTime"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Total Searches:</strong> <span id="logTotalSearches"></span><br>
                        <strong>Successful:</strong> <span id="logSuccessfulSearches"></span><br>
                        <strong>Properties Found:</strong> <span id="logTotalProperties"></span><br>
                        <strong>Properties Saved:</strong> <span id="logPropertiesSaved"></span>
                    </div>
                </div>
                
                <div id="logErrorSection" class="mb-3" style="display: none;">
                    <div class="alert alert-danger">
                        <strong>Error:</strong> <span id="logErrorMessage"></span>
                        <div id="logErrorDetails" class="mt-2" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="logContent" class="form-label">Log Content (Last 100 lines)</label>
                    <textarea class="form-control" id="logContent" rows="20" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadLog()">
                    <i class="fas fa-download"></i> Download Full Log
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentLogExecutionId = null;

// Initialize page
$(document).ready(function() {
    console.log('Page loaded, initializing...'); // Debug log
    
    // Check if form exists
    const form = $('#scraperConfigForm');
    console.log('Form found:', form.length > 0); // Debug log
    
    // Check if form elements exist
    console.log('isEnabled found:', $('#isEnabled').length > 0); // Debug log
    console.log('scheduleInterval found:', $('#scheduleInterval').length > 0); // Debug log
    console.log('timeoutMinutes found:', $('#timeoutMinutes').length > 0); // Debug log
    console.log('maxWorkers found:', $('#maxWorkers').length > 0); // Debug log
    console.log('retryAttempts found:', $('#retryAttempts').length > 0); // Debug log
    
    loadScraperStatus();
    loadScraperConfig();
    loadScraperLogs();
    
    // Refresh status every 10 seconds
    setInterval(loadScraperStatus, 10000);
});

function loadScraperStatus() {
    fetch('/api/scraper_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatusCards(data.data);
                updateSchedulerToggle(data.data);
            }
        })
        .catch(error => console.error('Error loading scraper status:', error));
}

function updateStatusCards(status) {
    // Scheduler Status
    const schedulerStatus = status.scheduler_running ? 'Running' : 'Stopped';
    const schedulerClass = status.scheduler_running ? 'text-success' : 'text-danger';
    $('#schedulerStatus').html(`<span class="${schedulerClass}">${schedulerStatus}</span>`);
    
    // Scraper Status
    const scraperStatus = status.scraper_running ? 'Running' : 'Idle';
    const scraperClass = status.scraper_running ? 'text-success' : 'text-secondary';
    $('#scraperStatus').html(`<span class="${scraperClass}">${scraperStatus}</span>`);
    
    // Next Run
    if (status.next_scheduled_run) {
        const nextRun = new Date(status.next_scheduled_run).toLocaleString();
        $('#nextRun').text(nextRun);
    } else {
        $('#nextRun').text('Not scheduled');
    }
    
    // Last Run
    if (status.scraper_last_run) {
        const lastRun = new Date(status.scraper_last_run).toLocaleString();
        $('#lastRun').text(lastRun);
    } else {
        $('#lastRun').text('Never');
    }
}

function updateSchedulerToggle(status) {
    const button = $('#schedulerToggle');
    if (status.scheduler_running) {
        button.html('<i class="fas fa-stop"></i> Stop Scheduler');
        button.removeClass('btn-warning').addClass('btn-danger');
        button.attr('onclick', 'stopScheduler()');
    } else {
        button.html('<i class="fas fa-clock"></i> Start Scheduler');
        button.removeClass('btn-danger').addClass('btn-warning');
        button.attr('onclick', 'startScheduler()');
    }
}

function loadScraperConfig() {
    fetch('/api/scraper_config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.data;
                $('#isEnabled').prop('checked', config.is_enabled);
                $('#scheduleInterval').val(config.schedule_interval_minutes);
                $('#timeoutMinutes').val(config.timeout_minutes);
                $('#maxWorkers').val(config.max_concurrent_workers);
                $('#retryAttempts').val(config.retry_attempts);
            }
        })
        .catch(error => console.error('Error loading scraper config:', error));
}

function loadScraperLogs() {
    fetch('/api/scraper_logs')
        .then(response => response.json())
        .then(data => {
            if (data.data) {
                const tbody = $('#scraperLogsTable tbody');
                tbody.empty();
                
                data.data.forEach(log => {
                    const row = `
                        <tr>
                            <td><code>${log.execution_id.substring(0, 8)}...</code></td>
                            <td><span class="badge bg-${getStatusBadgeClass(log.status)}">${log.status}</span></td>
                            <td>${log.start_time}</td>
                            <td>${log.duration}</td>
                            <td>${log.successful_searches}/${log.total_searches}</td>
                            <td>${log.properties_saved}/${log.total_properties}</td>
                            <td>${log.actions}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        })
        .catch(error => console.error('Error loading scraper logs:', error));
}

function getStatusBadgeClass(status) {
    switch (status.toLowerCase()) {
        case 'running': return 'primary';
        case 'completed': return 'success';
        case 'failed': return 'danger';
        case 'cancelled': return 'warning';
        default: return 'secondary';
    }
}

function startScraper() {
    fetch('/api/scraper/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast(data.message);
                loadScraperStatus();
            } else {
                showErrorToast(data.message);
            }
        })
        .catch(error => {
            showErrorToast('Failed to start scraper');
            console.error('Error starting scraper:', error);
        });
}

function startScheduler() {
    fetch('/api/scheduler/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast(data.message);
                loadScraperStatus();
            } else {
                showErrorToast(data.message);
            }
        })
        .catch(error => {
            showErrorToast('Failed to start scheduler');
            console.error('Error starting scheduler:', error);
        });
}

function stopScheduler() {
    fetch('/api/scheduler/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast(data.message);
                loadScraperStatus();
            } else {
                showErrorToast(data.message);
            }
        })
        .catch(error => {
            showErrorToast('Failed to stop scheduler');
            console.error('Error stopping scheduler:', error);
        });
}

function toggleScheduler() {
    // This function will be replaced by startScheduler or stopScheduler
    // based on the current state
}

// Form submission
$('#scraperConfigForm').on('submit', function(e) {
    e.preventDefault();
    console.log('Form submitted!'); // Debug log
    
    const config = {
        is_enabled: $('#isEnabled').is(':checked') ? 1 : 0,
        schedule_interval_minutes: parseInt($('#scheduleInterval').val()),
        timeout_minutes: parseInt($('#timeoutMinutes').val()),
        max_concurrent_workers: parseInt($('#maxWorkers').val()),
        retry_attempts: parseInt($('#retryAttempts').val())
    };
    
    console.log('Config data:', config); // Debug log
    
    fetch('/api/scraper_config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(response => {
        console.log('Response received:', response); // Debug log
        return response.json();
    })
    .then(data => {
        console.log('Data received:', data); // Debug log
        if (data.success) {
            showSuccessToast(data.message);
            loadScraperStatus();
        } else {
            showErrorToast(data.message);
        }
    })
    .catch(error => {
        console.error('Error updating configuration:', error);
        showErrorToast('Failed to update configuration');
    });
});

// Also try binding with document ready
$(document).ready(function() {
    console.log('Binding form submission event...'); // Debug log
    
    $('#scraperConfigForm').on('submit', function(e) {
        console.log('Form submitted via document ready binding!'); // Debug log
        e.preventDefault();
        
        const config = {
            is_enabled: $('#isEnabled').is(':checked') ? 1 : 0,
            schedule_interval_minutes: parseInt($('#scheduleInterval').val()),
            timeout_minutes: parseInt($('#timeoutMinutes').val()),
            max_concurrent_workers: parseInt($('#maxWorkers').val()),
            retry_attempts: parseInt($('#retryAttempts').val())
        };
        
        console.log('Config data from document ready binding:', config);
        
        fetch('/api/scraper_config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response from document ready binding:', data);
            if (data.success) {
                showSuccessToast(data.message);
                loadScraperStatus();
            } else {
                showErrorToast(data.message);
            }
        })
        .catch(error => {
            console.error('Error from document ready binding:', error);
            showErrorToast('Failed to update configuration');
        });
    });
});

// Global functions for log actions
function viewScraperLog(executionId) {
    currentLogExecutionId = executionId;
    
    fetch(`/api/scraper_logs/${executionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const log = data.data;
                
                $('#logExecutionId').text(log.execution_id);
                $('#logStatus').text(log.status);
                $('#logStartTime').text(log.start_time ? new Date(log.start_time).toLocaleString() : 'N/A');
                $('#logEndTime').text(log.end_time ? new Date(log.end_time).toLocaleString() : 'N/A');
                $('#logTotalSearches').text(log.total_searches);
                $('#logSuccessfulSearches').text(log.successful_searches);
                $('#logTotalProperties').text(log.total_properties);
                $('#logPropertiesSaved').text(log.properties_saved);
                
                // Show/hide error section
                if (log.error_message) {
                    $('#logErrorMessage').text(log.error_message);
                    $('#logErrorSection').show();
                    
                    if (log.error_details) {
                        $('#logErrorDetails').html(log.error_details.replace(/\n/g, '<br>')).show();
                    } else {
                        $('#logErrorDetails').hide();
                    }
                } else {
                    $('#logErrorSection').hide();
                }
                
                // Set log content
                $('#logContent').val(log.log_content.join(''));
                
                $('#logViewerModal').modal('show');
            } else {
                showErrorToast(data.message);
            }
        })
        .catch(error => {
            showErrorToast('Failed to load log details');
            console.error('Error loading log details:', error);
        });
}

function downloadScraperLog(executionId) {
    fetch(`/api/scraper_logs/${executionId}/download`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create a temporary link to download the file
                const link = document.createElement('a');
                link.href = data.file_path;
                link.download = data.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showErrorToast(data.message);
            }
        })
        .catch(error => {
            showErrorToast('Failed to download log');
            console.error('Error downloading log:', error);
        });
}

function downloadLog() {
    if (currentLogExecutionId) {
        downloadScraperLog(currentLogExecutionId);
    }
}

function testConfigUpdate() {
    const config = {
        is_enabled: $('#isEnabled').is(':checked') ? 1 : 0,
        schedule_interval_minutes: parseInt($('#scheduleInterval').val()),
        timeout_minutes: parseInt($('#timeoutMinutes').val()),
        max_concurrent_workers: parseInt($('#maxWorkers').val()),
        retry_attempts: parseInt($('#retryAttempts').val())
    };

    console.log('Testing config update with:', config);

    fetch('/api/scraper_config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Test config update response:', data);
        if (data.success) {
            showSuccessToast(data.message);
            loadScraperStatus(); // Refresh status to show updated config
        } else {
            showErrorToast(data.message);
        }
    })
    .catch(error => {
        console.error('Error testing config update:', error);
        showErrorToast('Failed to test config update');
    });
}
</script>
{% endblock %}
